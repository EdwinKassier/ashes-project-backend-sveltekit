name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  create:
    tags:
      - 'prod/v*'

env:
  PROJECT_ID: ${{ secrets.PROJECT_ID }}
  RUN_REGION: us-central1
  REPO_NAME: ${{ github.event.repository.name }}
  NODE_VERSION: '18'

jobs:
  # Quality checks for all pushes, PRs, and tag creation
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'create'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format:check

  # Testing for all pushes, PRs, and tag creation
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'create'
    needs: quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

      - name: Run integration tests
        run: npm run test:integration

  # Security scan for all pushes, PRs, and tag creation
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'create'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm run security:audit
        continue-on-error: true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: npm-audit.json
        continue-on-error: true

  # Docker build for pushes and PRs (not production deploy)
  build:
    name: Docker Build
    needs: [quality, test, security]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t ${{ env.REPO_NAME }}:${{ github.sha }} .

      - name: Test Docker image
        run: |
          docker run -d -p 3000:3000 \
            -e NODE_ENV=production \
            -e DATABASE_URL="file:./test.db" \
            --name test-container \
            ${{ env.REPO_NAME }}:${{ github.sha }}
          sleep 15
          curl -f http://localhost:3000/health || exit 1
          docker stop test-container
          docker rm test-container

  # Production deployment ONLY on prod/v* tag creation
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event_name == 'create' && startsWith(github.ref, 'refs/tags/prod/v')
    needs: [quality, test, security]
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify tag deployment
        run: |
          echo "üöÄ Starting production deployment for tag: ${{ github.ref }}"
          echo "Tag name: ${GITHUB_REF#refs/tags/}"
          echo "This deployment is triggered by tag creation only"

      - name: Extract version from tag
        id: extract_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/prod/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "SERVICE_NAME=${{ env.REPO_NAME }}-prod" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build SvelteKit
        run: npm run build

      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.SA_KEY_JSON }}
          project_id: ${{ env.PROJECT_ID }}
          export_default_credentials: true

      - name: Authenticate to Google Cloud
        run: |
          echo '${{ secrets.SA_KEY_JSON }}' > /tmp/service-account-key.json
          gcloud auth activate-service-account --key-file=/tmp/service-account-key.json
          gcloud config set project ${{ env.PROJECT_ID }}

      - name: Create Artifact Registry repository
        run: |
          gcloud artifacts repositories create ${{ env.REPO_NAME }} \
            --repository-format=docker \
            --location=${{ env.RUN_REGION }} \
            --description="Docker repository for ${{ env.REPO_NAME }}" || echo "Repository already exists"

      - name: Verify authentication
        run: |
          gcloud auth list
          gcloud config get-value project

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.RUN_REGION }}-docker.pkg.dev

      - name: Test Docker authentication
        run: |
          echo "Testing Docker authentication..."
          gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin https://${{ env.RUN_REGION }}-docker.pkg.dev

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.RUN_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ steps.extract_version.outputs.SERVICE_NAME }}:${{ steps.extract_version.outputs.VERSION }} .
          docker push ${{ env.RUN_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ steps.extract_version.outputs.SERVICE_NAME }}:${{ steps.extract_version.outputs.VERSION }}
        env:
          DOCKER_BUILDKIT: 1

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ steps.extract_version.outputs.SERVICE_NAME }} \
            --image ${{ env.RUN_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ steps.extract_version.outputs.SERVICE_NAME }}:${{ steps.extract_version.outputs.VERSION }} \
            --region ${{ env.RUN_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port=3000 \
            --memory=512Mi \
            --cpu=1 \
            --max-instances=10 \
            --set-env-vars="NODE_ENV=production" \
            --set-env-vars="VERSION=${{ steps.extract_version.outputs.VERSION }}" \
            --set-env-vars="JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --set-env-vars="DATABASE_URL=${{ secrets.DATABASE_URL }}"

      - name: Ensure public access
        run: |
          echo "Ensuring service is publicly accessible..."
          gcloud run services add-iam-policy-binding ${{ steps.extract_version.outputs.SERVICE_NAME }} \
            --region=${{ env.RUN_REGION }} \
            --member="allUsers" \
            --role="roles/run.invoker" || echo "IAM policy may already be set"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ steps.extract_version.outputs.SERVICE_NAME }} --region=${{ env.RUN_REGION }} --format="value(status.url)")
          echo "Service URL: $SERVICE_URL"

          echo "Waiting for service to be ready..."
          sleep 10

          echo "Testing /health endpoint..."
          curl -v "$SERVICE_URL/health" || echo "Health endpoint failed"

          echo "Testing /ready endpoint..."
          curl -v "$SERVICE_URL/ready" || echo "Ready endpoint failed"

          echo "Final health check..."
          if curl -f "$SERVICE_URL/health"; then
            echo "‚úÖ Deployment verified successfully"
          else
            echo "‚ùå Health check failed, but deployment may still be working"
            echo "Service URL: $SERVICE_URL"
            echo "Please check the service manually"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Production Release ${{ steps.extract_version.outputs.VERSION }}
          body: |
            ## Production Release ${{ steps.extract_version.outputs.VERSION }}

            This release has been automatically deployed to production after passing all quality checks and tests.

            ### Changes
            - See commit history for detailed changes

            ### Deployment Details
            - **Service**: ${{ steps.extract_version.outputs.SERVICE_NAME }}
            - **Version**: ${{ steps.extract_version.outputs.VERSION }}
            - **Region**: ${{ env.RUN_REGION }}
            - **Environment**: Production

            ### Quality Checks Passed
            - ‚úÖ TypeScript type checking
            - ‚úÖ Code formatting (Prettier)
            - ‚úÖ Linting (ESLint)
            - ‚úÖ Security scan (npm audit)
            - ‚úÖ Unit tests
            - ‚úÖ SvelteKit build verification
          draft: false
          prerelease: false
